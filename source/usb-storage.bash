#!/bin/bash

parted /dev/sdb print
# Model: SanDisk Cruzer Edge (scsi)
# Disk /dev/sdb: 32.0GB
# Sector size (logical/physical): 512B/512B
# Partition Table: msdos
# Disk Flags:

# Number	Start	End					Size	Type	File system	Flags
# 1		32,8kB	2852MB	2852MB	primary				boot,	hidden
# 2		2852MB	2945MB	93,4MB	primary

start=$(du --block-size=1MB kali-linux-2016.1-amd64.iso | awk '{print $1}')
echo "Size of image is $start MB"
# Size of image is 2956 MB

parted -a optimal /dev/sdb mkpart primary "${start}MB" 100%
# Information: You may need to update	/etc/fstab.

parted /dev/sdb print
# Model: SanDisk Cruzer Edge (scsi)
# Disk /dev/sdb: 32,0GB
# Sector size (logical/physical): 512B/512B
# Partition Table: msdos
# Disk Flags:

# Number	Start		End		Size		Type		File system		Flags
# 1		32,8kB		2852MB		2852MB		primary
# 2		2852MB		2945MB		93,4MB		primary
# 3		2946MB		32,0GB		29,1GB		primary

mkfs.ext4 -L persistence /dev/sdb3
# mke2fs 1.43-WIP (15-Mar-2016)
# Creating filesystem with 7096832 4k blocks and 1777664 inodes
# Filesystem UUID: dede20c4-5239-479a-b115-96561ac857b6
# Superblock backups stored on blocks:
#	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 4096000
# Allocating group tables: done
# Writing inode tables: done
# Creating journal (32768 blocks): done
# Writing superblocks and filesystem accounting information: done

mount /dev/sdb3 /mnt
echo "/ union" >/mnt/persistence.conf
ls -l  /mnt
# total 20
# drwx------ 2 root root 16384 May 10 13:31 lost+found
# -rw-r--r-- 1 root root     8 May 10 13:34 persistence.conf

umount /mnt
cryptsetup --verbose --verify-passphrase luksFormat /dev/sdb312

# WARNING!
# ========
# Are you sure? (Type uppercase yes): YES
# Enter passphrase:
# Verify successful:
# Command successful.

cryptsetup luksOpen /dev/sdb3 kali_persistence
# Enter passphrase for /dev/sdb3:

mkfs.ext4 -L persistence /dev/mapper/kali_persistence
# mke2fs 1.43-WIP (15-Mr-2016)
# Creating filesystem with 7096320 4k blocks and 1774192 inodes
# Filesystem UUID: 287892c1-00bb-43cb-b513-81cc9e6fa72b
# Superblock backups stored on blocks:
# 	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2644208, 4096000
#
# Allocating group tables: done
# Writing superblocks and filesystem accounting information: done

mount /dev/mapper/kali_persistence /mnt
echo "/ unione" >/mnt/persistence.conf
unmount /mnt
cryptsetup luksClose /dev/mapper/kali_persistence

#!/bin/sh

if [! -d isolinux]; then
	cd binary
fi

cat >>isolinux/live.cfg <<END

label live-demo
	menu label ^Live USB with Demo Data
	linux /live/vmlinuz
	initrd /live/initrd.img
	append boot=live username=root hotsname=kali persistence-label=work persistence-encryption=luks persistence
END

parted /dev/sdb mkpart primary 3000 MB 55%
parted /dev/sdb mkpart primary 55 % 100 %
mkfs.ext4 -L demo /dev/sdb3
# [...]

mount /dev/sdb3 /mnt
echo "/ union" >/mnt/persistence.conf
unmount /mnt
cryptsetup --verbose --verify-passphrase luksFormat /dev/sdb4
# [...]

cryptsetup luksOpen /dev/sdb64 kali_persistence
# [...]

mkfs.ext4 -L work /dev/mapper/kali_persistence
# [...]

mount /dev/mapper/kali_persistence /mnt
echo "/ union" >/mnt/persistence.conf
unmount /mnt
cryptsetup luksClose /dev/mapper/kali_persistence
