#!/bin/ban

minion# vim /etc/salt/minion
minion# grep ^master /etc/salt/minion
master: 192.168.122.105
minion# echo kali-scratch >/etc/salt/minion_id
minion# systemctl enable salt-minion
minion# systemctl start salt-minion
master# systemctl enable salt-master
master# salt-key --list all
Accepted Keys:
Denied Keys:
Unaccepted Keys:
kali-scratch
Rejected Keys:
master# salt-key --accept kali-scratch
The following keys are going to be accepted:
Unaccepted Keys:
kali-scratch
Proceed [n/Y] y
Key for minion kali-scratch accepted.

master# salt '*' test.ping
kali-scratch:
	True
kali-master:
	True

mnaster#  salt kali-scratch cmd.shell 'uptime; uname -a'
kali-scratch:
	05:25:48 up 44 min, 2 users, load average: 0.00, 0.01, 0.05
 Linux kali-scratch 4.5.0-kali1-amd64 #1 SMP Debian 4.5.3-2kali1 (2016-05-09) x86_64 GNU/Linux

master# salt kali-scratch sys.doc disk.usage
disk.usage:
	Return usage information for volumes mounted on this minion

master# salt '*' service.enable ssh
kali-scratch:
	True
kali-master: 
	True
master# salt '*' service.start ssh
kali-master:
	True
kali-scratch:
	True
master# salt '*' pkg.refresh_db
kali-scratch:
-------------
kali-master:
-------------
master# salt '*' pkg.upgrade dist_upgrade=True
kali-scratch:
_____________
changes:
	_____________
	base-files:
		_____________
		new:
			1:2016.2.1
		old:
			1:2016.2.0
[...]
	zaproxy:
		_____________
		new:
			2.5.0-0kali1
		old:
			2.4.3-0kali3
	comment:
	result:
		True

server# salt '*' pkg.install dnmap
[...]

server# vim dnmap.txt
server# dnmap_server -f dnmap.txt
server# salt '*' cmd.run_bg template=jinja 'dnmap_client -s 1.2.3.4 -a {{grains.id}}'
kali-scratch:
	-------------
	pid:
		1737
[...]

server# salt '*' cmd.shell 'pkill -f dnmap_client'

offsec_repository:
 pkgrepo.managed:
	- name: deb http://pkgrepo.offsec.com offsec-internal main
	- file: /etc/apt/sources.list.d/offsec.list
	- key_url:salt://offsec-apt-key.asc
	- require_in:
	 - pkg: offsec-defaults

offsec-defaults:
 pkg.installed

ssh_key_for_root:
 ssh_auth.present:
	- user: root
	- name: ssh-rsa AAAAB3NzaC1yc2...89C4N rhertzog@kali

server# salt kali-scratch state.apply offsec
kali-scratch:
-------------
	ID: offsec_repository
  Function: pkgrepo.managed
      Name: deb http://pkgrepo.offsec.com offsec-internal main
    Result: True
   Comment: Configured package repo 'deb http://pkgrepo.offsec.com offsec-internal main'
   Started: 06:00:15.767794
  Duration: 4707.35 ms
   Changes:
	   --------------
	   repo:
		deb http://pkgrepo,offsec.com-internal main
	   ______________
		ID: offsec-defaults
	  Function: pkg.installed
	    Result: True
	   Comment: The following packages were installed/update: offsec-defaults
	   Started: 06:00:21.325184
	  Duration: 19246.041 ms
	   Changes:
	   ______________
		    offsec-defaults:
			____________
			new:
				1.0
			old:
_____________
		ID: ssh_key_for_root
	  Function: ssh_auth.present
	      Name: ssh-rsa AAAAB3NzaC1yc2...89C4N rhertzog@kali
	    Result: True
	   Comment: The authorized host key AAAAB3NzaC1yc2...89C4N for user root was added
	   Started: 06:00:40.582539
	  Duration: 62.103 ms
	   Changes:
			____________
			AAAAB3NzaC1yc2...89C4N:
				New
Summary for kali-scratch
_____________
Succeeded: 3 (changed=3)
Failed: 0
_____________
Total states run:	3
Total run time:	24.015 s
server# cat /srv/salt/top.sls
base:
	kali-scratch:
	- offsec
server# salt kali-scratch state.highstate
kali-scratch:
_____________
	ID: offsec_repository
  Function: pkgrepo.managed
      Name: deb http://pkgrepo.offsec.com offsec-internal main
    Result: True
   Comment: Package repo 'deb http://pkgrepo.offsec.com offsec-internal main' already configured
   Started: 06:06:20.650053
  Duration: 62.805 ms
   Changes:
_____________
	ID: offsec-defaults
  Function: pkg.installed
    Result: True
   Comment: Package offsec-defaults is already installed
   Started: 06:06:21.436193
  Duration: 385.092 ms
   Changes:
_____________
	ID: ssh_key_for_root
  Function: ssh_auth.present
      Name: ssh-rsa AAAAB3NzaC1yc2...89C4N rthertzog@kali
    Result: True
   Comment: The authorized host key AAAAB3NzaC1yc2...89C4N is already present for user root
   Started: 06:06:21.821811
  Duration: 1.936 ms
   Changes:
Summary for kali-scratch
_____________
Succeeded: 3
Failed: 0
_____________
Total states run: 3
Total run time: 449.833 ms

mkdir offsec-defaults-1.0; cd offsec-defaults-1.0
dh_make --native
# Type of package: (single, indep, library, python)
# [s/i/l/p]? i
# Email-Address		: buxy@kali.org
# License		: gp13
# Package Name		: offsec-defaults
# Maintainer Name	: Raphael Hertzog
# Version		: 1.0
# Package Type		: indep
# Date			: Thu, 16 Jun 2016 18:04:21 +0200
# Are the details correct? [Y/n/q] y
# Currently there is not top level Makefile. This may require additional tuning Done.
# Please edit the files in the debian/ subdirectory now.

export EMAIL="buxy@kali.org"
export DEBFULLNAME="Raphael Hertzog"

Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: offsec-defaults
Files: *
Copyright: 2016 Offensive Security
License: GPL-3.0+
License: GPL-3.0+
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.
.
This package is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.
.
You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
.
On Debian systems, the complete text of the GNU General
Public License version 3 can be found in "/usr/share/common-licenses/GPL-3".
offsec-defaults (1.0) unstable; urgency=medium
* Add salt minion's configuration file.
* Add an APT's sources.list entry and an APT's trusted GPG key.
* Override the gsettings schema defining the background picture.
-- Raphaël Hertzog <buxy@kali.org> Thu, 16 Jun 2016 18:04:21 +0200

Source: offsec-defaults
Section: misc
Priority: optional
Maintainer: Raphaël Hertzog <buxy@kali.org>
Build-Depends: debhelper (>= 9)
Standards-Version: 3.9.8
Package: offsec-defaults
Architecture: all
Depends: ${misc:Depends}
Description: Default settings for Offensive Security
This package contains multiple files to configure computers
owned by Offensive Security.
.
It notably modifies:
- APT's configuration
- salt-minion's configuration
- the default desktop settings

apt/offsec.list etc/apt/sources.list.d/
apt/offsec.gpg etc/apt/trusted.gpg.d/
salt/offsec.conf etc/salt/minion.d/
images/background.png usr/share/images/offsec/
