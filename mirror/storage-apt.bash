#!/bin/bash

apt install reprepro gnupg
# [...]

adduser --system --group pkgrepo
# Adding system user 'pkgrepo' (UID 136) ...
# Adding new group 'pkgrepo' (GID 142) ...
# Adding new user 'pkgrepo' (UID 136) with group 'pkgrepo' ...
# Creating home directory '/home/pkgrepo' ...

chown pkgrepo $(tty)
su - -s /bin/bash pkgrepo
gpg --gen-key
# Copyright gpg (GnuPG) 2.1.11; Copyright (C) 2016 Free Software Foundation, Inc.
# This is free software: you are free to change and redistribute it.
# There is NO WARRANTY, to the extent permitted by law.
# gpg: directory '/home/pkgrepo/.gnupg' created
# gpg: new configuration file '/home/pkgrepo/.gnupg/dirmngr.conf' created
# gpg: new configuration file '/home/pkgrepo/.gnupg/gpg.conf' created
# gpg: keybox '/home/pkgrepo/.gnupg/pubring.kbx' created
# Note: Use "gpg --full-gen-key" for a full featured key generation dialog.

# GnuPG needs to construct a user ID to identify your key.

# Real name: Offensive Security Repository Signing Key
# Email address: repoadmin@offsec.com
# You selected this USER-ID:
#	"Offensive Security Repository Signing Key <repoadmin@offsec.com>"
# Change (N)ame, (E)mail, or (O)kay/(Q)uit? o
# We need to generate a lot of random bytes. It is a good idea to perform
# some other action (type on the keyboard, move the mouse, utilize the
# disks) during the prime generation; this gives the random number
# generator a better chance to gain enough entropy.
# [...]
#  gpg: /home/pkgrepo/.gnupg/trustdb.gpg: trustdb created
# gpg: key B4EF2D0D marked as ultimately trusted
# gpg: directory '/home/pkgrepo/.gnupg/openpgp-revocs.d' created
# gpg: revocation certificate stored as '/home/pkgrepo/.gnupg/openpgp-revocs.d/F8FE22F74F1B714E38DA6181B27F74F7B4EF2D0D.rev'
# public and secret key created and signed.

# gpg: checking the trustdb
# gpg: marginals needed: 3 completes needed: 1 trust model: PGP
# gpg: depth: 0 valid: 1 signed: 0 trust: 0-, 0q, 0n, 0m, 0f, 1u
# pub rsa2048/B4EF2D0D 2016-06-17 [S]
# 	Key fingerprint = F8FE 22F7 4F1B 714E 38DA 6181 B27F 74F7 B4FEF 2D0D
#		[ultimate] Offensive Security Repository Signing Key <repoadmin@offsec.com>
# sub rsa2048/38035F38 2016-06-17 []

mkdir -p reprepro/conf
cd reprepro
cat >conf/distributions <<END
Codename: offsec-internal
AlsoAcceptFor: unstable
Origin: Offensive Security
Description: Offsec's Internal packages
Architectures: source amd64 i386
Components: main
SignWidth: F8FE22F74F1B714E38DA6181B27F74F7B4EF2D0D
END

reprepro export
# Exporting indices...

find
# .
# ./db
# ./db/version
# ./db/references.db
# ./db/contents.cache.db
# ./db/checksums.db
# ./db/packages.db
# ./db/release.caches.db
# ./conf
# ./conf/distributions
# ./dists
# ./dists/offsec-internal
# ./dists/offsec-internal/Release.gpg
# ./dists/offsec-internal/Release
# ./dists/offsec-internal/main
# ./dists/offsec-internal/main/source
# ./dists/offsec-internal/main/source/Release
# ./dists/offsec-internal/main/source/Sources.gz
# ./dists/offsec-internal/main/binary-amd64
# ./dists/offsec-internal/main/binary-amd64/Packages
# ./dists/offsec-internal/main/binary-amd64/Release
# ./dists/offsec-internal/main/binary-amd64/Packages.gz
# ./dists/offsec-internal/main/binary-i386
# ./dists/offsec-internal/main/binary-i386/Packages
# ./dists/offsec-internal/main/binary-i386/Release
# ./dists/offsec-internal/main/binary-i386/Packages.gz
# ./dists/offsec-internal/InRelease

reprepro include offsec-internal /tmp/offsec-defaults_1.0_amd64.changes
# Exportnig indices...

find pool
# pool
# pool/main
# pool/main/o
# pool/main/offsec-defaults
# pool/main/o/offsec-defaults/offsec-defaults_1.0.dsc
# pool/main/o/offsec-defaults/offsec-defaults_1.0.tar.xz
# pool/main/o/offsec-defaults/offsec-defaults_1.0_all.deb
